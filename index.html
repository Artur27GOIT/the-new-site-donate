<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–ù–µ—Ö–∞–π –±—É–¥–µ –ú–ò–†</title>
    <link
      rel="icon"
      href="./icon/made-in-ukraine-icon.svg"
      type="image/svg+xml"
    />

    <link rel="stylesheet" href="./style/style.css" />
  </head>
  <body>
    <main class="card" role="main" aria-label="–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ–¥—è–∫–∏">
      <h1>
        –ó—Ä–æ–±–∏ —Å–≤—ñ–π –≤–∫–ª–∞–¥ –¥–ª—è –º–∏—Ä—É –Ω–∞ –Ω–∞—à—ñ–π –ó–µ–º–ª—ñ<br />
        –†–∞–∑–æ–º –º–∏ —Å–∏–ª–∞!
      </h1>
      <span class="element-heart">‚ù§Ô∏è‚Äçü©π</span>
      <div class="container-button">
        <button class="donate-btn">–ó–∞–¥–æ–Ω–∞—Ç–∏—Ç–∏</button>
      </div>

      <!-- ------------------------------------–°–µ–∫—Ü—ñ—è —Ä–æ–∑—ñ–≥—Ä–∞—à—É--------------------------------------- -->

      <!-- ===== –ë–ª–æ–∫ –£–º–æ–≤–∏ —Ä–æ–∑—ñ–≥—Ä–∞—à—É ===== -->
      <section class="raffle-intro">
        <h2>–£–º–æ–≤–∏ —Ä–æ–∑—ñ–≥—Ä–∞—à—É</h2>
        <p>–î—ñ–∑–Ω–∞–π—Ç–µ—Å—å –¥–µ—Ç–∞–ª—ñ —Ç–∞ —è–∫ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –Ω–∞ –µ–º–æ—Ü—ñ—ó!</p>
        <button class="scroll-btn" id="scrollToRaffle">
          –ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ä–æ–∑—ñ–≥—Ä–∞—à—É
        </button>
      </section>

      <!---------------------------------------- –°–µ–∫—Ü—ñ—è —Ä–æ–∑—ñ–≥—Ä–∞—à—É---------------------------------------      -->

      <section
        class="card raffle-card"
        id="raffleSection"
        role="region"
        aria-label="–†–æ–∑—ñ–≥—Ä–∞—à —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É"
      >
        <h2>–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –Ω–∞ –µ–º–æ—Ü—ñ—ó <span class="emoji">üéÅ</span></h2>

        <div class="raffle-image">
          <img src="your-image.jpg" alt="–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –Ω–∞ –µ–º–æ—Ü—ñ—ó" />
        </div>
        <p>
          –£—á–∞—Å—Ç—å —É —Ä–æ–∑—ñ–≥—Ä–∞—à—ñ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å—ñ–º, —Ö—Ç–æ –∑—Ä–æ–±–∏–≤ –¥–æ–Ω–∞—Ç. –û–±–µ—Ä—ñ—Ç—å —Å–≤—ñ–π –±—ñ–ª–µ—Ç
          —Ç–∞ –≤–∏–≥—Ä–∞–π—Ç–µ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è –Ω–µ–π–º–æ–≤—ñ—Ä–Ω–∏—Ö –µ–º–æ—Ü—ñ–π!
        </p>
        <div class="container-button">
          <button class="donate-btn">–ó–∞–¥–æ–Ω–∞—Ç–∏—Ç–∏</button>
        </div>
      </section>

      <!---------------------------------------- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ---------------------------------------      -->
      <div class="modal" id="donateModal">
        <div class="modal-content">
          <span class="close-btn" id="closeModalBtn">&times;</span>
          <h2>–í–∑—è—Ç–∏ —É—á–∞—Å—Ç—å —É —Ä–æ–∑—ñ–≥—Ä–∞—à—ñ</h2>

          <!-- action="https://script.google.com/macros/s/AKfycbxp-51Z59AwnGMbWk1hKoanZU5wA4v5n_yr-l_gyg-IPWmbFV7aUQTftbo8jk-s1mgf/exec" -->
          <!-- method="POST" -->
          <!-- target="_blank" -->

          <form class="donate-form" id="googleForm">
            <label for="firstName">–Ü–º‚Äô—è</label>
            <input
              type="text"
              id="firstName"
              name="firstName"
              placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º‚Äô—è"
              required
            />

            <label for="lastName">–ü—Ä—ñ–∑–≤–∏—â–µ</label>
            <input
              type="text"
              id="lastName"
              name="lastName"
              placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ –ø—Ä—ñ–∑–≤–∏—â–µ"
              required
            />

            <label for="amount">–°—É–º–∞ –¥–æ–Ω–∞—Ç—É (–≥—Ä–Ω)</label>
            <input
              type="number"
              id="amount"
              name="amount"
              placeholder="50"
              min="50"
              step="50"
              required
            />

            <label>–ù–æ–º–µ—Ä –±—ñ–ª–µ—Ç—É</label>
            <div class="ticket-grid">
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="1" />
                <span>1</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="2" />
                <span>2</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="3" />
                <span>3</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="4" />
                <span>4</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="5" />
                <span>5</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="6" />
                <span>6</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="7" />
                <span>7</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="8" />
                <span>8</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="9" />
                <span>9</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="10" />
                <span>10</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="11" />
                <span>11</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="12" />
                <span>12</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="13" />
                <span>13</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="14" />
                <span>14</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="15" />
                <span>15</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="16" />
                <span>16</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="17" />
                <span>17</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="18" />
                <span>18</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="19" />
                <span>19</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="20" />
                <span>20</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="21" />
                <span>21</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="22" />
                <span>22</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="23" />
                <span>23</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="24" />
                <span>24</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="25" />
                <span>25</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="26" />
                <span>26</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="27" />
                <span>27</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="28" />
                <span>28</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="29" />
                <span>29</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="30" />
                <span>30</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="31" />
                <span>31</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="32" />
                <span>32</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="33" />
                <span>33</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="34" />
                <span>34</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="35" />
                <span>35</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="36" />
                <span>36</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="37" />
                <span>37</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="38" />
                <span>38</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="39" />
                <span>39</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="40" />
                <span>40</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="41" />
                <span>41</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="42" />
                <span>42</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="43" />
                <span>43</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="44" />
                <span>44</span>
              </label>
              <label class="ticket">
                <input type="checkbox" name="ticketNumber" value="45" />
                <span>45</span>
              </label>
            </div>

            <button type="submit" class="submit-btn">–í–∑—è—Ç–∏ —É—á–∞—Å—Ç—å</button>
          </form>
        </div>
      </div>
    </main>
    <div class="modal" id="messageModal">
      <div class="modal-content">
        <span class="close-btn" id="closeMessageModal">&times;</span>
        <p id="messageText"></p>
      </div>
    </div>

    <!-- —Å–∫—Ä—ñ–ø—Ç –º–æ–¥–∞–ª–∫–∏ -->
    <script>
      function isMobile() {
        return /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(
          navigator.userAgent
        );
      }

      const donateButtons = document.querySelectorAll(".donate-btn");
      const closeModal = document.getElementById("closeModalBtn");
      const modal = document.getElementById("donateModal");

      const donateForm = document.querySelector(".donate-form");
      const amountInput = document.getElementById("amount");
      const ticketCheckboxes = document.querySelectorAll(
        'input[name="ticketNumber"]'
      );

      const monoJarLink = "https://send.monobank.ua/jar/2pDvqLCWa2";

      const messageModal = document.getElementById("messageModal");
      const messageText = document.getElementById("messageText");
      const closeMessageModal = document.getElementById("closeMessageModal");

      function showMessage(msg) {
        messageText.textContent = msg;
        messageModal.classList.add("active");
      }

      closeMessageModal.addEventListener("click", () => {
        messageModal.classList.remove("active");
      });

      window.addEventListener("click", (e) => {
        if (e.target === messageModal) messageModal.classList.remove("active");
      });

      // ----------------------------------------–í—ñ–¥–∫—Ä–∏—Ç—Ç—è / –∑–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–∫–∏---------------------------------------
      donateButtons.forEach((btn) => {
        btn.addEventListener("click", () => modal.classList.add("active"));
      });

      closeModal.addEventListener("click", () =>
        modal.classList.remove("active")
      );

      window.addEventListener("click", (e) => {
        if (e.target === modal) modal.classList.remove("active");
      });

      // ===== –û–±–º–µ–∂–µ–Ω–Ω—è –±—ñ–ª–µ—Ç—ñ–≤ –ø–æ —Å—É–º—ñ =====
      function updateTicketAvailability() {
        const amount = parseInt(amountInput.value);
        const maxTickets = Math.floor(amount / 50);

        if (isNaN(amount) || amount < 50) {
          ticketCheckboxes.forEach((cb) => {
            cb.checked = false;
            cb.disabled = true;
          });
          return;
        }

        const checkedCount = Array.from(ticketCheckboxes).filter(
          (cb) => cb.checked
        ).length;

        ticketCheckboxes.forEach((cb) => {
          if (!cb.checked && checkedCount >= maxTickets) cb.disabled = true;
          else cb.disabled = false;
        });
      }

      amountInput.addEventListener("input", updateTicketAvailability);
      ticketCheckboxes.forEach((cb) =>
        cb.addEventListener("change", updateTicketAvailability)
      );

      // ===== –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–∞–π–Ω—è—Ç–∏—Ö –±—ñ–ª–µ—Ç—ñ–≤ =====
      let takenTickets = [];

      fetch("https://sheetdb.io/api/v1/564kk8ptt07xm")
        .then((res) => res.json())
        .then((data) => {
          takenTickets = data.flatMap((row) => row.Tickets.split(","));
          ticketCheckboxes.forEach((cb) => {
            if (takenTickets.includes(cb.value)) {
              cb.disabled = true;
              cb.parentElement.classList.add("taken");
            }
          });
        })
        .catch((err) =>
          console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ –∑–∞–π–Ω—è—Ç–∏—Ö –±—ñ–ª–µ—Ç—ñ–≤:", err)
        );

      // ===== –û–±–º–µ–∂–µ–Ω–Ω—è –±—ñ–ª–µ—Ç—ñ–≤ –ø–æ —Å—É–º—ñ =====
      function updateTicketAvailability() {
        const amount = parseInt(amountInput.value);
        const maxTickets = Math.floor(amount / 50);

        const checkedCount = Array.from(ticketCheckboxes).filter(
          (cb) => cb.checked
        ).length;

        ticketCheckboxes.forEach((cb) => {
          if (!cb.checked && checkedCount >= maxTickets) cb.disabled = true;
          else if (!takenTickets.includes(cb.value)) cb.disabled = false;
        });
      }

      amountInput.addEventListener("input", updateTicketAvailability);
      ticketCheckboxes.forEach((cb) =>
        cb.addEventListener("change", updateTicketAvailability)
      );

      // ===== Submit —Ñ–æ—Ä–º–∏ =====
      donateForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const firstName = document.getElementById("firstName").value.trim();
        const lastName = document.getElementById("lastName").value.trim();
        const amount = parseInt(document.getElementById("amount").value) || 0;
        const selectedTickets = Array.from(ticketCheckboxes)
          .filter((cb) => cb.checked)
          .map((cb) => cb.value);

        const maxTickets = Math.floor(amount / 50);

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
        if (
          !firstName ||
          !lastName ||
          amount < 50 ||
          selectedTickets.length === 0 ||
          selectedTickets.length > maxTickets
        ) {
          showMessage("–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –≤—Å—ñ –ø–æ–ª—è —Ç–∞ –±—ñ–ª–µ—Ç–∏.");
          return;
        }

        // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑–∞–π–Ω—è—Ç—ñ –±—ñ–ª–µ—Ç–∏
        const conflict = selectedTickets.some((ticket) =>
          takenTickets.includes(ticket)
        );
        if (conflict) {
          showMessage(
            "–û–¥–∏–Ω –∞–±–æ –±—ñ–ª—å—à–µ –æ–±—Ä–∞–Ω–∏—Ö –±—ñ–ª–µ—Ç—ñ–≤ –≤–∂–µ –∫—É–ø–ª–µ–Ω—ñ. –û–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—ñ."
          );
          return;
        }

        // ===== –§–æ—Ä–º–∞—Ç—É—î–º–æ Timestamp =====
        const now = new Date();
        const timestamp = `${now.getDate().toString().padStart(2, "0")}/${(
          now.getMonth() + 1
        )
          .toString()
          .padStart(2, "0")}/${now.getFullYear()} ${now
          .getHours()
          .toString()
          .padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}`;

        const formData = {
          Timestamp: timestamp,
          "First Name": firstName,
          "Last Name": lastName,
          Amount: amount,
          Tickets: selectedTickets.join(","),
        };

        // ===== –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–∏—Ö =====
        fetch("https://sheetdb.io/api/v1/564kk8ptt07xm", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
        })
          .then((response) => {
            if (!response.ok) throw new Error("–°–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É");
            showMessage("–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ! –î—è–∫—É—î–º–æ –∑–∞ –¥–æ–Ω–∞—Ç.");
            if (isMobile()) {
              window.location.href = monoJarLink;
            } else {
              window.open(monoJarLink, "_blank");
            }

            donateForm.reset();
            ticketCheckboxes.forEach(
              (cb) => (cb.disabled = takenTickets.includes(cb.value))
            );
          })
          .catch((err) => {
            alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ –¥–∞–Ω–∏—Ö");
            console.error(err);
          });
      });
      const scrollBtn = document.getElementById("scrollToRaffle");
      const raffleSection = document.getElementById("raffleSection");

      scrollBtn.addEventListener("click", () => {
        raffleSection.scrollIntoView({ behavior: "smooth" });
      });
      // =================== –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–∏ –∑–º—ñ–Ω—ñ —Ç–∞–±–ª–∏—Ü—ñ ===================
let lastRowCount = 0;

// —Å—Ç–≤–æ—Ä—é—î–º–æ –º–æ–¥–∞–ª–∫—É –¥–∏–Ω–∞–º—ñ—á–Ω–æ (—â–æ–± –Ω–µ —á—ñ–ø–∞—Ç–∏ HTML)
const updateModal = document.createElement("div");
updateModal.classList.add("modal");
updateModal.innerHTML = `
  <div class="modal-content">
    <h3>üîÑ –î–∞–Ω—ñ –æ–Ω–æ–≤–∏–ª–∏—Å—å!</h3>
    <p>–ó‚Äô—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ñ —É—á–∞—Å–Ω–∏–∫–∏ –∞–±–æ –±—ñ–ª–µ—Ç–∏. –û–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É?</p>
    <div style="display: flex; justify-content: center; gap: 1rem; margin-top: 1rem;">
      <button id="refreshConfirm" class="submit-btn">–û–Ω–æ–≤–∏—Ç–∏</button>
      <button id="refreshCancel" class="donate-btn">–ü—ñ–∑–Ω—ñ—à–µ</button>
    </div>
  </div>
`;
document.body.appendChild(updateModal);

const refreshConfirm = updateModal.querySelector("#refreshConfirm");
const refreshCancel = updateModal.querySelector("#refreshCancel");

refreshConfirm.addEventListener("click", () => {
  location.reload();
});

refreshCancel.addEventListener("click", () => {
  updateModal.classList.remove("active");
});

async function checkForNewData() {
  try {
    const res = await fetch("https://sheetdb.io/api/v1/564kk8ptt07xm");
    const data = await res.json();

    const currentRowCount = data.length;

    // —è–∫—â–æ —î –∑–º—ñ–Ω–∏ ‚Äî –ø–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª–∫—É
    if (lastRowCount && currentRowCount !== lastRowCount) {
      updateModal.classList.add("active");
      console.log("üì¢ –í–∏—è–≤–ª–µ–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —É —Ç–∞–±–ª–∏—Ü—ñ. –ü—Ä–æ–ø–æ–Ω—É—î–º–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...");
    }

    lastRowCount = currentRowCount;
  } catch (err) {
    console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –æ–Ω–æ–≤–ª–µ–Ω—å:", err);
  }
}

// –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
setInterval(checkForNewData, 10000);
checkForNewData();

    </script>
  </body>
</html>
